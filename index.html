<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DHIS2 Bulk Dataset Upload</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* ... (keep all your existing styles) ... */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #f0f4f8; font-family: 'Oswald', sans-serif; }
        /* Add all your existing styles here */
    </style>
</head>
<body>

<!-- Login Screen -->
<div class="login-screen" id="loginScreen">
    <div class="login-card">
        <div class="logo-container">
            <div class="logo-box">
                <img src="https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg" alt="ICF-SL">
            </div>
        </div>
        <div class="login-header">
            <h1>DHIS2 BULK DATASET UPLOAD</h1>
            <p>Upload Excel data directly into any DHIS2 dataset</p>
        </div>
        <form id="loginForm">
            <div class="form-group">
                <label class="form-label">Google Apps Script Proxy URL</label>
                <input type="url" class="form-input" id="proxyUrl" placeholder="https://script.google.com/macros/s/YOUR_ID/exec" required>
                <small style="color:#666; font-size:11px;">Paste the URL from your GAS deployment</small>
            </div>
            <div class="form-group">
                <label class="form-label">DHIS2 Instance URL</label>
                <input type="url" class="form-input" id="instanceUrl" placeholder="https://your-dhis2.org" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-input" id="username" placeholder="admin" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
            </div>
            <button type="submit" class="btn-primary" id="loginBtn">üîó Connect to DHIS2</button>
        </form>
    </div>
</div>

<!-- Main Content -->
<div class="main-content" id="mainContent">
    <!-- ... rest of your main content ... -->
</div>

<div class="notification" id="notif"></div>

<script>
// ============================================================
//  PROXY COMMUNICATION - UPDATED FOR RELIABILITY
// ============================================================

let PROXY = 'https://script.google.com/macros/s/AKfycbzcaSDJTj1s0QDSMc3If4cn1tCay14HSmSh7QAy04i6hIfDORX8sednWEEj_O_DIhgG/exec';
let cfg = null;

// Test proxy connection first
async function testProxy(proxyUrl) {
    try {
        const response = await fetch(proxyUrl);
        const text = await response.text();
        
        // Try to parse as JSON
        try {
            const data = JSON.parse(text);
            return { ok: true, data };
        } catch (e) {
            // If it's HTML but contains our test message, it might be working
            if (text.includes('DHIS2 Proxy is running')) {
                return { ok: true, data: { message: 'Proxy is working' } };
            }
            return { ok: false, error: 'Proxy returned invalid response' };
        }
    } catch (err) {
        return { ok: false, error: err.message };
    }
}

// Unified proxy request function
async function proxyRequest(endpoint, method = 'GET', payload = null) {
    if (!cfg || !PROXY) throw new Error('Not connected');
    
    const targetUrl = cfg.instanceUrl + endpoint;
    const auth = 'Basic ' + btoa(`${cfg.username}:${cfg.password}`);
    
    // Prepare request body for proxy
    const requestBody = {
        url: targetUrl,
        Authorization: auth,
        method: method,
        timestamp: new Date().toISOString()
    };
    
    // Add payload for POST requests
    if (payload && method === 'POST') {
        requestBody.payload = payload;
    }
    
    console.log('Sending to proxy:', { method, endpoint, hasPayload: !!payload });
    
    try {
        const response = await fetch(PROXY, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestBody)
        });
        
        const text = await response.text();
        
        // Check if response is HTML
        if (text.trim().startsWith('<')) {
            console.error('Proxy returned HTML:', text.substring(0, 200));
            throw new Error('Proxy returned HTML. Check GAS deployment.');
        }
        
        // Parse JSON response
        try {
            return JSON.parse(text);
        } catch (e) {
            console.error('Invalid JSON response:', text.substring(0, 200));
            throw new Error('Invalid JSON from proxy');
        }
    } catch (err) {
        console.error('Proxy request failed:', err);
        throw err;
    }
}

// DHIS2 helpers
async function dhis2Get(path) {
    return proxyRequest(path, 'GET');
}

async function dhis2Post(path, body) {
    return proxyRequest(path, 'POST', body);
}

// ============================================================
//  LOGIN
// ============================================================
document.getElementById('loginForm').addEventListener('submit', async e => {
    e.preventDefault();
    
    const proxyUrl = document.getElementById('proxyUrl').value.trim();
    const instanceUrl = document.getElementById('instanceUrl').value.trim().replace(/\/$/, '');
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;
    
    const btn = document.getElementById('loginBtn');
    btn.disabled = true; btn.textContent = 'Testing proxy...';
    
    try {
        // First test the proxy
        const proxyTest = await testProxy(proxyUrl);
        if (!proxyTest.ok) {
            throw new Error(`Proxy not responding: ${proxyTest.error}`);
        }
        
        // Set global proxy URL
        PROXY = proxyUrl;
        cfg = { instanceUrl, username, password };
        
        // Test DHIS2 connection
        btn.textContent = 'Connecting to DHIS2...';
        const user = await dhis2Get('/api/me');
        
        if (user && user.id) {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainContent').classList.add('active');
            notify(`Connected! Welcome ${user.displayName || user.name || 'User'}`, 'success');
            
            // Load initial data
            loadOuLevels();
            loadCOCs();
        } else {
            throw new Error('Invalid response from DHIS2');
        }
    } catch (err) {
        notify(`Connection failed: ${err.message}`, 'error');
        cfg = null;
        PROXY = '';
    } finally {
        btn.disabled = false; btn.textContent = 'üîó Connect to DHIS2';
    }
});

// ============================================================
//  NOTIFICATION
// ============================================================
function notify(msg, type = 'info') {
    const n = document.getElementById('notif');
    n.textContent = msg;
    n.className = `notification ${type}`;
    clearTimeout(n._t);
    n._t = setTimeout(() => n.className = 'notification', 5000);
}

function log(msg, type = 'info') {
    const b = document.getElementById('logBox');
    if (!b) return;
    const d = document.createElement('div');
    d.className = `log-entry ${type}`;
    d.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
    b.appendChild(d);
    b.scrollTop = b.scrollHeight;
}

function clearLog() {
    const b = document.getElementById('logBox');
    if (b) b.innerHTML = '';
}

function setProg(pct) {
    const f = document.getElementById('progressFill');
    if (!f) return;
    f.style.width = pct + '%';
    f.textContent = pct + '%';
}

// ============================================================
//  STEP NAVIGATION
// ============================================================
function goStep(n) {
    document.querySelectorAll('.step-panel').forEach(p => p.classList.remove('active'));
    const panel = document.getElementById(`panel-${n}`);
    if (panel) panel.classList.add('active');
    
    document.querySelectorAll('.step-tab').forEach((t, i) => {
        t.classList.remove('active', 'done');
        if (i + 1 === n) t.classList.add('active');
        else if (i + 1 < n) t.classList.add('done');
    });
}

// ============================================================
//  METADATA LOADING
// ============================================================
let allDatasets = [];
let selectedDataset = null;
let ouLevels = [];
let dhis2COCs = [];
let selectedOuLevel = null;

async function loadOuLevels() {
    try {
        const data = await dhis2Get('/api/organisationUnitLevels.json?fields=id,level,displayName&paging=false&order=level:asc');
        ouLevels = data.organisationUnitLevels || [];
        const sel = document.getElementById('ouLevelSelect');
        if (sel) {
            sel.innerHTML = '<option value="">-- Select level --</option>' +
                ouLevels.map(l => `<option value="${l.id}" data-level="${l.level}">${l.displayName} (Level ${l.level})</option>`).join('');
        }
    } catch (e) {
        console.error('OU levels error:', e);
    }
}

async function loadCOCs() {
    try {
        const data = await dhis2Get('/api/categoryOptionCombos.json?fields=id,displayName,name&paging=false');
        dhis2COCs = data.categoryOptionCombos || [];
        const sel = document.getElementById('defaultCocSel');
        if (sel) {
            const def = dhis2COCs.find(c => /default/i.test(c.displayName)) || dhis2COCs[0];
            sel.innerHTML = dhis2COCs.map(c => `<option value="${c.id}" ${c.id === def?.id ? 'selected' : ''}>${c.displayName || c.name}</option>`).join('');
        }
    } catch (e) {}
}

async function loadDatasets() {
    const btn = document.getElementById('loadDatasetsBtn');
    const status = document.getElementById('dsLoadStatus');
    if (!btn || !status) return;
    
    btn.disabled = true; btn.textContent = '‚è≥ Loading...';
    try {
        const data = await dhis2Get('/api/dataSets.json?fields=id,displayName,name,periodType,dataSetElements[dataElement[id,displayName,name]]&paging=false');
        allDatasets = data.dataSets || [];
        const sel = document.getElementById('datasetSelect');
        if (sel) {
            sel.innerHTML = '<option value="">-- Select a dataset --</option>' +
                allDatasets.map(ds => `<option value="${ds.id}">${ds.displayName || ds.name}</option>`).join('');
        }
        status.innerHTML = `‚úÖ ${allDatasets.length} datasets loaded`;
        notify(`Loaded ${allDatasets.length} datasets`, 'success');
    } catch (err) {
        status.innerHTML = `‚úó ${err.message}`;
        notify(`Failed: ${err.message}`, 'error');
    } finally {
        btn.disabled = false; btn.textContent = 'üîÑ Load All Datasets';
    }
}

function onDatasetChange() {
    const id = document.getElementById('datasetSelect')?.value;
    selectedDataset = id ? allDatasets.find(d => d.id === id) : null;
    const nextBtn = document.getElementById('step1Next');
    if (nextBtn) nextBtn.disabled = !(selectedDataset && selectedOuLevel);
    if (excelHeaders.length) buildMappingTable();
}

function onOuLevelChange() {
    const sel = document.getElementById('ouLevelSelect');
    if (!sel) return;
    const opt = sel.options[sel.selectedIndex];
    selectedOuLevel = opt.value ? { id: opt.value, level: parseInt(opt.dataset.level) } : null;
    const nextBtn = document.getElementById('step1Next');
    if (nextBtn) nextBtn.disabled = !(selectedDataset && selectedOuLevel);
}

// ============================================================
//  FILE HANDLING
// ============================================================
let wb = null;
let excelHeaders = [];
let excelRows = [];

// ... rest of your existing file handling functions ...

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Set up dropzone if it exists
    const dz = document.getElementById('dropZone');
    if (dz) {
        dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('over'); });
        dz.addEventListener('dragleave', () => dz.classList.remove('over'));
        dz.addEventListener('drop', e => { 
            e.preventDefault(); 
            dz.classList.remove('over'); 
            if (e.dataTransfer.files[0]) processFile(e.dataTransfer.files[0]); 
        });
    }
});

// Export functions to global scope
window.goStep = goStep;
window.loadDatasets = loadDatasets;
window.onDatasetChange = onDatasetChange;
window.onOuLevelChange = onOuLevelChange;
window.handleFile = function(e) { if (e.target.files[0]) processFile(e.target.files[0]); };
window.clearFile = function(e) {
    e.stopPropagation();
    wb = null; excelHeaders = []; excelRows = [];
    const badge = document.getElementById('fileBadge');
    const sheetRow = document.getElementById('sheetRow');
    const fileInput = document.getElementById('fileInput');
    const step2Next = document.getElementById('step2Next');
    if (badge) badge.style.display = 'none';
    if (sheetRow) sheetRow.style.display = 'none';
    if (fileInput) fileInput.value = '';
    if (step2Next) step2Next.disabled = true;
};
window.reloadSheet = function() { /* implement */ };
window.autoMapAll = function() { /* implement */ };
window.buildPreview = function() { /* implement */ };
window.startUpload = function() { /* implement */ };
window.resetAll = function() { /* implement */ };
</script>
</body>
</html>
